# üìä Excel Export Sistemi

> **Durum:** ‚úÖ Geli≈ütirme Tamamlandƒ±  
> **Tarih:** 14 Ekim 2025  
> **Versiyon:** 1.0.0

---

## ‚ú® √ñzellikler

### ‚úÖ Tamamlanan √ñzellikler

1. **√áoklu Rapor Export**
   - √úretim raporlarƒ± (production plans)
   - Stok raporlarƒ± (hammadde, yarƒ± mamul, nihai)
   - Operat√∂r performans raporlarƒ±
   - Sipari≈ü raporlarƒ±

2. **Geli≈ümi≈ü Excel Formatƒ±**
   - √áoklu worksheet (sayfa) desteƒüi
   - √ñzet + detay sayfalarƒ±
   - Otomatik kolon geni≈ülikleri
   - Formatlƒ± headers

3. **Akƒ±llƒ± Veri ƒ∞≈üleme**
   - Otomatik hesaplamalar (toplam, ortalama)
   - M√º≈üteri bazlƒ± analiz
   - Durum filtreleme
   - Tarih aralƒ±ƒüƒ± desteƒüi

4. **Kullanƒ±cƒ± Dostu**
   - Tek tƒ±kla indirme
   - "T√ºm√ºn√º ƒ∞ndir" √∂zelliƒüi (4 rapor birden)
   - Otomatik dosya adlandƒ±rma

---

## üìã Export T√ºrleri

### 1. √úretim Raporu
**Endpoint:** `/api/reports/export/production`

**Worksheets:**
- **√ñzet:** Toplam/tamamlanan/devam eden/iptal planlar
- **√úretim Detay:** Plan kodu, sipari≈ü, √ºr√ºn, ilerleme, operat√∂r, tarihler

**√ñrnek √áƒ±ktƒ±:**
```
Sheet 1: √ñzet
‚îú‚îÄ Toplam Plan: 45
‚îú‚îÄ Tamamlandƒ±: 32
‚îú‚îÄ Devam Ediyor: 8
‚îî‚îÄ Toplam √úretilen: 1,250 adet

Sheet 2: √úretim Detay
‚îú‚îÄ Plan Kodu | Sipari≈ü | √úr√ºn | Hedef | √úretilen | ƒ∞lerleme% | ...
‚îú‚îÄ PLAN-001  | SIP-123 | TRX-1| 100   | 95       | 95%       | ...
‚îî‚îÄ ...
```

---

### 2. Stok Raporu
**Endpoint:** `/api/reports/export/stock`

**Worksheets:**
- **√ñzet:** Toplam √ºr√ºn sayƒ±larƒ±, kritik stoklar, toplam deƒüer
- **Hammaddeler:** 86 adet hammadde + maliyet analizi
- **Yarƒ± Mam√ºller:** 12 adet yarƒ± mamul + kullanƒ±labilir stok
- **Nihai √úr√ºnler:** 244 adet √ºr√ºn + kar marjƒ±

**√ñrnek √áƒ±ktƒ±:**
```
Sheet 1: √ñzet
‚îú‚îÄ Hammadde Sayƒ±sƒ±: 86
‚îú‚îÄ Yarƒ± Mamul Sayƒ±sƒ±: 12
‚îú‚îÄ Nihai √úr√ºn Sayƒ±sƒ±: 244
‚îú‚îÄ Kritik Stok (Hammadde): 12
‚îî‚îÄ Toplam Stok Deƒüeri: ‚Ç∫125,450.00

Sheet 2-4: Detaylƒ± listeler
```

---

### 3. Operat√∂r Raporu
**Endpoint:** `/api/reports/export/operators`

**Worksheets:**
- **√ñzet:** Toplam operat√∂r, aktif/bo≈üta, kapasite kullanƒ±mƒ±
- **Operat√∂rler:** Seri, ad, deneyim, kapasite, √ºretim sayƒ±sƒ±, verimlilik

**√ñrnek √áƒ±ktƒ±:**
```
Sheet 1: √ñzet
‚îú‚îÄ Toplam Operat√∂r: 2
‚îú‚îÄ Aktif: 1
‚îú‚îÄ Toplam Kapasite: 92 saat/g√ºn
‚îî‚îÄ Kullanƒ±m: 50%

Sheet 2: Operat√∂r Detaylarƒ±
‚îú‚îÄ Seri | Ad | Deneyim | Kapasite | Aktif √úretim | Verimlilik% | ...
‚îú‚îÄ thunder | Thunder Op | 5 yƒ±l | 46 saat | 2 | 95% | ...
‚îî‚îÄ ...
```

---

### 4. Sipari≈ü Raporu
**Endpoint:** `/api/reports/export/orders`

**Worksheets:**
- **√ñzet:** Toplam sipari≈ü, durum daƒüƒ±lƒ±mƒ±, toplam tutar
- **Sipari≈ü Detay:** Sipari≈ü no, m√º≈üteri, √ºr√ºn, miktar, fiyat, durum
- **M√º≈üteri Analizi:** M√º≈üteri bazlƒ± sipari≈ü sayƒ±sƒ± ve toplam tutar

**√ñrnek √áƒ±ktƒ±:**
```
Sheet 1: √ñzet
‚îú‚îÄ Toplam Sipari≈ü: 18
‚îú‚îÄ Onay Bekleyen: 3
‚îú‚îÄ Tamamlandƒ±: 12
‚îî‚îÄ Toplam Tutar: ‚Ç∫245,000

Sheet 2: Sipari≈ü Detay
Sheet 3: M√º≈üteri Analizi
```

---

## üöÄ Kullanƒ±m

### 1. Raporlar Sayfasƒ±ndan ƒ∞ndirme

**Nerede:** `http://localhost:3000/raporlar`

**Y√∂ntem 1: Ana Butonlar (Saƒü √ºst)**
- **"T√ºm√ºn√º ƒ∞ndir"** ‚Üí 4 rapor birden indirilir (sƒ±rayla)
- **"√ñzet Rapor"** ‚Üí (Gelecekte eklenecek)

**Y√∂ntem 2: Tab Bazlƒ±**
1. ƒ∞stediƒüin rapor tab'ƒ±na git (√úretim/Stok/Operat√∂r/Sipari≈ü)
2. **"Excel ƒ∞ndir"** butonuna tƒ±kla
3. Excel dosyasƒ± otomatik indirilir

**Dosya Adlarƒ±:**
- `production-raporu-2025-10-14.xlsx`
- `stock-raporu-2025-10-14.xlsx`
- `operators-raporu-2025-10-14.xlsx`
- `orders-raporu-2025-10-14.xlsx`

---

### 2. API Kullanƒ±mƒ± (Programmatik)

```typescript
// √úretim raporu
const response = await fetch('/api/reports/export/production');
const blob = await response.blob();
// ... download

// Tarih filtreli
fetch('/api/reports/export/production?startDate=2025-10-01&endDate=2025-10-14');

// Durum filtreli
fetch('/api/reports/export/production?status=tamamlandi');

// Kombine
fetch('/api/reports/export/orders?startDate=2025-10-01&status=completed');
```

---

### 3. Curl ile ƒ∞ndirme

```bash
# √úretim raporu
curl http://localhost:3000/api/reports/export/production -o uretim.xlsx

# Stok raporu
curl http://localhost:3000/api/reports/export/stock -o stok.xlsx

# Operat√∂r raporu
curl http://localhost:3000/api/reports/export/operators -o operator.xlsx

# Sipari≈ü raporu (filtreli)
curl "http://localhost:3000/api/reports/export/orders?status=completed" -o siparisler.xlsx
```

---

## üîå API Endpoints

### 1. GET `/api/reports/export/production`

**Query Params:**
- `startDate`: YYYY-MM-DD (opsiyonel)
- `endDate`: YYYY-MM-DD (opsiyonel)
- `status`: beklemede/devam_ediyor/tamamlandi/iptal (opsiyonel)

**Response:** Excel file (.xlsx)

---

### 2. GET `/api/reports/export/stock`

**Query Params:** Yok (t√ºm stoklarƒ± export eder)

**Response:** Excel file (.xlsx)
- Sheet 1: √ñzet
- Sheet 2: Hammaddeler (86 adet)
- Sheet 3: Yarƒ± Mam√ºller (12 adet)
- Sheet 4: Nihai √úr√ºnler (244 adet)

---

### 3. GET `/api/reports/export/operators`

**Query Params:** Yok

**Response:** Excel file (.xlsx)
- Sheet 1: √ñzet
- Sheet 2: Operat√∂r Detaylarƒ± (t√ºm operat√∂rler)

---

### 4. GET `/api/reports/export/orders`

**Query Params:**
- `startDate`: YYYY-MM-DD
- `endDate`: YYYY-MM-DD
- `status`: pending/approved/in_production/completed/cancelled

**Response:** Excel file (.xlsx)
- Sheet 1: √ñzet
- Sheet 2: Sipari≈ü Detay
- Sheet 3: M√º≈üteri Analizi

---

## üìä Excel Dosya Yapƒ±sƒ±

### Genel Format

```
Excel Dosyasƒ± (*.xlsx)
‚îú‚îÄ Sheet 1: √ñzet
‚îÇ  ‚îú‚îÄ Metrik-Deƒüer formatƒ±
‚îÇ  ‚îú‚îÄ Toplam sayƒ±lar
‚îÇ  ‚îú‚îÄ Y√ºzde hesaplamalarƒ±
‚îÇ  ‚îî‚îÄ Rapor tarihi
‚îÇ
‚îú‚îÄ Sheet 2: Detaylƒ± Veri
‚îÇ  ‚îú‚îÄ Kolon ba≈ülƒ±klarƒ± (bold)
‚îÇ  ‚îú‚îÄ T√ºm kayƒ±tlar
‚îÇ  ‚îú‚îÄ Formatlƒ± sayƒ±lar
‚îÇ  ‚îî‚îÄ Otomatik kolon geni≈ülikleri
‚îÇ
‚îî‚îÄ Sheet 3+: Ek Analizler (varsa)
   ‚îî‚îÄ M√º≈üteri analizi, trend, vb.
```

### √ñrnek: Stok Raporu Yapƒ±sƒ±

```excel
üìÑ stok-raporu-2025-10-14.xlsx

‚îå‚îÄ üìë √ñzet
‚îÇ  Hammadde Sayƒ±sƒ±     | 86
‚îÇ  Yarƒ± Mamul Sayƒ±sƒ±   | 12
‚îÇ  Nihai √úr√ºn Sayƒ±sƒ±   | 244
‚îÇ  Toplam Stok Deƒüeri  | ‚Ç∫125,450
‚îÇ
‚îú‚îÄ üìë Hammaddeler
‚îÇ  Kod    | ƒ∞sim  | Miktar | Birim | Fiyat | Toplam | Durum
‚îÇ  HM-001 | √áelik | 100    | kg    | 50    | 5,000  | Normal
‚îÇ  HM-002 | Alu   | 25     | kg    | 80    | 2,000  | Kritik
‚îÇ
‚îú‚îÄ üìë Yarƒ± Mam√ºller
‚îÇ  ...
‚îÇ
‚îî‚îÄ üìë Nihai √úr√ºnler
   ...
```

---

## üíæ Teknoloji

### Kullanƒ±lan K√ºt√ºphaneler
- **xlsx** (SheetJS): Excel dosya olu≈üturma
- **Next.js API Routes**: Backend export endpoints

### Dosya Yapƒ±sƒ±
```
lib/utils/excel-export.ts       ‚Üê Utility fonksiyonlar
app/api/reports/export/
‚îú‚îÄ production/route.ts          ‚Üê √úretim export
‚îú‚îÄ stock/route.ts               ‚Üê Stok export
‚îú‚îÄ operators/route.ts           ‚Üê Operat√∂r export
‚îî‚îÄ orders/route.ts              ‚Üê Sipari≈ü export
```

---

## üß™ Test Senaryolarƒ±

### Test 1: Raporlar Sayfasƒ±ndan ƒ∞ndirme

1. `http://localhost:3000/raporlar` git
2. **"√úretim Raporlarƒ±"** tab'ƒ±na git
3. **"Excel ƒ∞ndir"** butonuna tƒ±kla
4. **Beklenen:** `production-raporu-2025-10-14.xlsx` indirilir ‚úÖ

**Dosyayƒ± Excel'de a√ß ve kontrol et:**
- ‚úÖ "√ñzet" sayfasƒ± var mƒ±?
- ‚úÖ "√úretim Detay" sayfasƒ± var mƒ±?
- ‚úÖ Veriler doƒüru mu?

---

### Test 2: T√ºm√ºn√º ƒ∞ndirme

1. Raporlar sayfasƒ±nda saƒü √ºstteki **"T√ºm√ºn√º ƒ∞ndir"** tƒ±kla
2. **Beklenen:** 4 Excel dosyasƒ± sƒ±rayla indirilir:
   - `production-raporu-*.xlsx`
   - `stock-raporu-*.xlsx`
   - `operators-raporu-*.xlsx`
   - `orders-raporu-*.xlsx`

---

### Test 3: API Doƒürudan Test

```bash
# Curl ile test
curl http://localhost:3000/api/reports/export/production -o test.xlsx

# Dosya boyutunu kontrol et
ls -lh test.xlsx  # 15-50 KB arasƒ± olmalƒ±

# Excel'de a√ß
open test.xlsx  # macOS
start test.xlsx # Windows
```

---

### Test 4: Filtreleme Testi

```bash
# Sadece tamamlanan √ºretimler
curl "http://localhost:3000/api/reports/export/production?status=tamamlandi" -o tamamlanan.xlsx

# Tarih aralƒ±ƒüƒ±
curl "http://localhost:3000/api/reports/export/orders?startDate=2025-10-01&endDate=2025-10-14" -o ekim.xlsx
```

---

## üéØ Kullanƒ±m Senaryolarƒ±

### Senaryo 1: Aylƒ±k √úretim Raporu

```typescript
// Ay sonu raporlama
const exportMonthlyProduction = async () => {
  const firstDay = new Date(2025, 9, 1).toISOString().split('T')[0];
  const lastDay = new Date(2025, 9, 31).toISOString().split('T')[0];
  
  const url = `/api/reports/export/production?startDate=${firstDay}&endDate=${lastDay}`;
  window.open(url, '_blank');
};
```

---

### Senaryo 2: Kritik Stok Raporu

```typescript
// Sadece kritik stoklarƒ± export et (√∂zel filtreleme)
// Not: ≈ûu an t√ºm stoklarƒ± export eder, 
// kritik olanlar Excel'de filtrelenebilir
const url = '/api/reports/export/stock';
window.open(url, '_blank');
```

---

### Senaryo 3: M√º≈üteri Sipari≈ü √ñzeti

```typescript
// Belirli m√º≈üterinin sipari≈üleri
// Not: Gelecekte customerId parametresi eklenebilir
const url = '/api/reports/export/orders';
window.open(url, '_blank');
```

---

## üîß Geli≈ütirici Notlarƒ±

### Yeni Rapor T√ºr√º Ekleme

```typescript
// 1. API endpoint olu≈ütur
// app/api/reports/export/custom/route.ts
import * as XLSX from 'xlsx';

export async function GET(request: NextRequest) {
  const workbook = XLSX.utils.book_new();
  
  // Veriyi hazƒ±rla
  const data = await fetchCustomData();
  
  // Worksheet olu≈ütur
  const worksheet = XLSX.utils.json_to_sheet(data);
  XLSX.utils.book_append_sheet(workbook, worksheet, 'Veri');
  
  // Buffer d√∂nd√ºr
  const buffer = XLSX.write(workbook, { type: 'buffer', bookType: 'xlsx' });
  return new NextResponse(buffer, {
    headers: {
      'Content-Type': 'application/vnd.openxmlformats-officedocument.spreadsheetml.sheet',
      'Content-Disposition': `attachment; filename="custom-rapor.xlsx"`
    }
  });
}

// 2. exportReport fonksiyonuna ekle
case 'custom':
  url = '/api/reports/export/custom';
  break;

// 3. UI'ye buton ekle
<Button onClick={() => exportReport('custom')}>
  √ñzel Rapor ƒ∞ndir
</Button>
```

---

## üêõ Troubleshooting

### Problem 1: "XLSX is not defined"
**√á√∂z√ºm:** xlsx package eksik.
```bash
npm install xlsx
```

### Problem 2: Dosya indirilmiyor
**√á√∂z√ºm:** Browser pop-up blocker. ƒ∞zin ver veya `window.open` yerine:
```typescript
const a = document.createElement('a');
a.href = downloadUrl;
a.download = filename;
a.click();
```

### Problem 3: "Network Error" (Production'da)
**√á√∂z√ºm:** API timeout. B√ºy√ºk raporlar i√ßin timeout artƒ±r:
```typescript
// next.config.ts
export default {
  api: {
    responseLimit: '10mb',
    bodyParser: {
      sizeLimit: '10mb'
    }
  }
}
```

---

## üìà Gelecek ƒ∞yile≈ütirmeler

- [ ] PDF export desteƒüi
- [ ] Tarih aralƒ±ƒüƒ± se√ßici (date picker UI)
- [ ] Grafikleri Excel'e ekleme (chart export)
- [ ] ≈ûablonlu export (template-based)
- [ ] Scheduled export (otomatik aylƒ±k rapor)
- [ ] Email ile g√∂nderim
- [ ] Zip ile toplu indirme

---

## üìû Destek

**Dok√ºmantasyon:** Bu dosya  
**GitHub:** https://github.com/Huseyintabak/ERP-V2  
**Issues:** https://github.com/Huseyintabak/ERP-V2/issues

---

**‚úÖ Sistem hazƒ±r! Raporlar sayfasƒ±ndan test et!** üöÄ

