# üß™ REAL TEST SENARYOSU - Adƒ±m Adƒ±m Rehber

**Tarih:** 8 Ekim 2025  
**Ama√ß:** Migration'ƒ± ger√ßek kullanƒ±cƒ± senaryosu ile test etmek

---

## üìã TEST ADIMLARI

### ADIM 0: Hazƒ±rlƒ±k (Opsiyonel)

**Ne Yapƒ±lacak:** Eski test verilerini temizle

**SQL:**
```sql
-- Supabase SQL Editor'da √ßalƒ±≈ütƒ±r:
-- Dosya: supabase/REAL-TEST-CLEANUP.sql
```

**Beklenen Sonu√ß:**
```
result: "ADIM 0: Test verileri temizlendi, stoklar sifirlandi"
```

**Sorun ya≈üarsanƒ±z:** "Adƒ±m 0'da problem"

---

### ADIM 1: BOM Kontrol√º

**Ne Yapƒ±lacak:** Finished product i√ßin BOM tanƒ±mlƒ± mƒ± kontrol et

**SQL:**
```sql
-- Supabase SQL Editor'da √ßalƒ±≈ütƒ±r:

SELECT 
    fp.code as product_code,
    fp.name as product_name,
    fp.barcode,
    bom.material_type,
    CASE 
        WHEN bom.material_type = 'raw' THEN rm.code
        ELSE sfp.code
    END as material_code,
    bom.quantity_needed
FROM finished_products fp
LEFT JOIN bom ON bom.finished_product_id = fp.id
LEFT JOIN raw_materials rm ON bom.material_type = 'raw' AND bom.material_id = rm.id
LEFT JOIN semi_finished_products sfp ON bom.material_type = 'semi' AND bom.material_id = sfp.id
WHERE fp.code LIKE 'NM%'
ORDER BY fp.code;
```

**Beklenen Sonu√ß:**
- En az 1 finished product
- Her √ºr√ºn i√ßin 2-3 malzeme BOM kaydƒ±

**Eƒüer BOM yoksa:** BOM ekleyin (UI veya SQL ile)

**Sorun ya≈üarsanƒ±z:** "Adƒ±m 1'de problem"

---

### ADIM 2: Planlama ile Login (UI)

**Ne Yapƒ±lacak:** Web uygulamasƒ±na planlama kullanƒ±cƒ±sƒ± ile giri≈ü yap

**Adƒ±mlar:**
1. http://localhost:3000 a√ß
2. Email: `planlama@thunder.com`
3. ≈ûifre: `123456`
4. Giri≈ü Yap

**Beklenen Sonu√ß:**
- Dashboard'a y√∂nlendirildiniz
- √úst men√ºde "Planlama Kullanƒ±cƒ±" g√∂r√ºn√ºyor

**Sorun ya≈üarsanƒ±z:** "Adƒ±m 2'de problem"

---

### ADIM 3: Yeni Sipari≈ü Olu≈ütur (UI)

**Ne Yapƒ±lacak:** Yeni bir sipari≈ü ekle

**UI Adƒ±mlarƒ±:**
1. Sidebar ‚Üí √úretim ‚Üí Sipari≈üler
2. "Yeni Sipari≈ü" butonu
3. Formu doldur:
   - M√º≈üteri: LTSAUTO (veya herhangi biri)
   - √úr√ºn: End√ºstriyel Kapƒ± (veya BOM'u olan √ºr√ºn)
   - Miktar: 3
   - √ñncelik: Orta
   - Teslim Tarihi: Gelecek bir tarih
4. "Sipari≈ü Olu≈ütur"

**Beklenen Sonu√ß:**
- Toast: "Sipari≈ü ba≈üarƒ±yla olu≈üturuldu"
- Sipari≈ü listesinde g√∂r√ºn√ºyor
- Durum: "Beklemede"

**SQL Kontrol√º:**
```sql
SELECT 
    order_number,
    status,
    order_items,
    created_at
FROM orders
WHERE created_at >= NOW() - INTERVAL '5 minutes'
ORDER BY created_at DESC
LIMIT 1;
```

**Sorun ya≈üarsanƒ±z:** "Adƒ±m 3'te problem" + hata mesajƒ±

---

### ADIM 4: Sipari≈üi Onayla (UI) - BOM SNAPSHOT TEST!

**Ne Yapƒ±lacak:** Olu≈üturduƒüun sipari≈üi onayla

**UI Adƒ±mlarƒ±:**
1. √úretim ‚Üí √úretim Y√∂netimi
2. "Bekleyen Sipari≈üler" tab'ƒ±
3. Yeni sipari≈üin yanƒ±ndaki "Onayla" butonu

**Beklenen Sonu√ß:**
- Toast: "Sipari≈ü onaylandƒ±"
- Sipari≈ü "√úretimdeki Sipari≈üler" tab'ƒ±na ge√ßti
- Production plan olu≈ütu

**SQL Kontrol√º (√ñNEMLƒ∞!):**
```sql
-- 1. Production plan olu≈ütu mu?
SELECT 
    pp.id as plan_id,
    pp.status,
    pp.planned_quantity,
    o.order_number
FROM production_plans pp
JOIN orders o ON pp.order_id = o.id
WHERE pp.created_at >= NOW() - INTERVAL '5 minutes'
ORDER BY pp.created_at DESC;

-- 2. BOM SNAPSHOT olu≈ütu mu? (MIGRATION TESTƒ∞!)
SELECT 
    plan_id,
    material_type,
    material_code,
    material_name,
    quantity_needed,
    'BOM Snapshot olusturuldu - create_bom_snapshot trigger calisti!' as test_result
FROM production_plan_bom_snapshot
WHERE plan_id = (
    SELECT id FROM production_plans 
    WHERE created_at >= NOW() - INTERVAL '5 minutes'
    ORDER BY created_at DESC 
    LIMIT 1
);
```

**Beklenen SQL Sonu√ß:**
- 1 production plan
- 2-3 BOM snapshot kaydƒ±
- test_result: "BOM Snapshot olusturuldu..."

**Sorun ya≈üarsanƒ±z:** "Adƒ±m 4'te problem" + SQL sonucu

---

### ADIM 5: Operat√∂r Atamasƒ± (UI)

**Ne Yapƒ±lacak:** Production plan'a operat√∂r ata

**UI Adƒ±mlarƒ±:**
1. √úretim ‚Üí √úretim Planlarƒ±
2. Yeni olu≈üan planƒ± bul
3. "Operat√∂r Ata" butonu (varsa)
4. Thunder Operat√∂r se√ß

**Alternatif - SQL ile:**
```sql
UPDATE production_plans
SET assigned_operator_id = (SELECT id FROM operators LIMIT 1)
WHERE id = (
    SELECT id FROM production_plans 
    WHERE created_at >= NOW() - INTERVAL '5 minutes'
    ORDER BY created_at DESC 
    LIMIT 1
)
RETURNING id, assigned_operator_id;
```

**Beklenen Sonu√ß:**
- assigned_operator_id dolu

**Sorun ya≈üarsanƒ±z:** "Adƒ±m 5'te problem"

---

### ADIM 6: Operat√∂r ile Login (UI)

**Ne Yapƒ±lacak:** Operat√∂r olarak giri≈ü yap

**Adƒ±mlar:**
1. √áƒ±kƒ±≈ü yap (saƒü √ºst)
2. http://localhost:3000/operator-login
3. Operat√∂r: Thunder Operat√∂r
4. ≈ûifre: 123456
5. Giri≈ü Yap

**Beklenen Sonu√ß:**
- Operat√∂r dashboard a√ßƒ±ldƒ±
- "Atanan Sipari≈üler" veya "Aktif √úretimler" listesinde sipari≈ü g√∂r√ºn√ºyor

**Sorun ya≈üarsanƒ±z:** "Adƒ±m 6'da problem"

---

### ADIM 7: Sipari≈üi Kabul Et (UI)

**Ne Yapƒ±lacak:** Atanan sipari≈üi kabul et

**Adƒ±mlar:**
1. "Atanan Sipari≈üler" b√∂l√ºm√ºnde sipari≈ü var mƒ± kontrol et
2. "Kabul Et" butonu (varsa)
3. Veya direkt "Aktif √úretimler" tab'ƒ±nda g√∂r√ºn√ºyorsa, devam et

**SQL ile Status G√ºncelleme (Alternatif):**
```sql
UPDATE production_plans
SET status = 'devam_ediyor',
    started_at = NOW()
WHERE id = (
    SELECT id FROM production_plans 
    WHERE created_at >= NOW() - INTERVAL '10 minutes'
    ORDER BY created_at DESC 
    LIMIT 1
)
RETURNING id, status;
```

**Beklenen Sonu√ß:**
- Plan status: "devam_ediyor"
- "Aktif √úretimler" listesinde g√∂r√ºn√ºyor

**Sorun ya≈üarsanƒ±z:** "Adƒ±m 7'de problem"

---

### ADIM 8: √úretim Modal'ƒ±nƒ± A√ß (UI)

**Ne Yapƒ±lacak:** Barkod okutma modal'ƒ±nƒ± a√ß

**Adƒ±mlar:**
1. "Aktif √úretimler" tab'ƒ±
2. Sipari≈üin yanƒ±ndaki "G√∂r√ºnt√ºle" butonu

**Beklenen Sonu√ß:**
- Modal a√ßƒ±ldƒ±
- √úr√ºn bilgileri g√∂r√ºn√ºyor
- Barkod input var
- Gerekli malzemeler listeleniyor

**Sorun ya≈üarsanƒ±z:** "Adƒ±m 8'de problem"

---

### ADIM 9: Barkod Okut (UI) - MIGRATION TEST!

**Ne Yapƒ±lacak:** √úr√ºn barkodunu okut ve √ºretim kaydet

**Adƒ±mlar:**
1. Barkod input'a √ºr√ºn barkodunu yaz (√∂rn: 8690123456789)
2. "Kaydet" butonu veya Enter

**VEYA SQL ile (√ñnerilen):**
```sql
-- Production log ekle (trigger'larƒ± tetikler!)
INSERT INTO production_logs (
    plan_id,
    operator_id,
    barcode_scanned,
    quantity_produced
)
SELECT 
    pp.id,
    pp.assigned_operator_id,
    fp.barcode,
    1
FROM production_plans pp
JOIN finished_products fp ON pp.product_id = fp.id
WHERE pp.created_at >= NOW() - INTERVAL '10 minutes'
  AND pp.status = 'devam_ediyor'
ORDER BY pp.created_at DESC
LIMIT 1
RETURNING id, barcode_scanned, quantity_produced;
```

**Beklenen Sonu√ß:**
- Toast: "√úretim kaydedildi"
- ƒ∞lerleme barƒ± g√ºncellendi (1/3)
- Son kayƒ±tlar listesinde g√∂r√ºn√ºyor

**Sorun ya≈üarsanƒ±z:** "Adƒ±m 9'da problem" + hata mesajƒ±

---

### ADIM 10: stock_movements Kontrol√º (SQL) - MIGRATION KANITI!

**Ne Yapƒ±lacak:** production_log_id dolu mu kontrol et

**SQL:**
```sql
-- EN KRITIK TEST!
SELECT 
    sm.id as movement_id,
    sm.material_type,
    sm.movement_type,
    sm.quantity,
    sm.production_log_id,  -- ‚Üê BU DOLU OLMALI!
    pl.barcode_scanned,
    pl.quantity_produced,
    sm.description,
    CASE 
        WHEN sm.production_log_id IS NOT NULL 
        THEN '‚úÖ MIGRATION BASARILI - production_log_id DOLU!'
        ELSE '‚ùå HATA - production_log_id BOS!'
    END as test_result
FROM stock_movements sm
LEFT JOIN production_logs pl ON sm.production_log_id = pl.id
WHERE sm.created_at >= NOW() - INTERVAL '2 minutes'
ORDER BY sm.created_at DESC
LIMIT 10;
```

**Beklenen Sonu√ß:**
```
2-3 kayƒ±t (her malzeme i√ßin 1)
material_type: raw
movement_type: uretim
production_log_id: <UUID> (DOLU!)
test_result: "MIGRATION BASARILI - production_log_id DOLU!"
```

**Sorun ya≈üarsanƒ±z:** "Adƒ±m 10'da problem" + SQL sonucu

---

### ADIM 11: Finished Product Stok Kontrol√º (SQL)

**Ne Yapƒ±lacak:** Finished product stoƒüu arttƒ± mƒ± kontrol et

**SQL:**
```sql
SELECT 
    fp.code,
    fp.name,
    fp.quantity as current_stock,
    'Her barkod okutmada +1 artmali' as note
FROM finished_products fp
WHERE fp.id = (
    SELECT product_id FROM production_plans
    WHERE created_at >= NOW() - INTERVAL '10 minutes'
    ORDER BY created_at DESC
    LIMIT 1
);
```

**Beklenen Sonu√ß:**
- quantity arttƒ± (+1 her barkod i√ßin)

**Sorun ya≈üarsanƒ±z:** "Adƒ±m 11'de problem" + sonu√ß

---

### ADIM 12: Raw Materials Stok Kontrol√º (SQL)

**Ne Yapƒ±lacak:** Hammadde stoklarƒ± azaldƒ± mƒ± kontrol et

**SQL:**
```sql
SELECT 
    rm.code,
    rm.name,
    rm.quantity as current_stock,
    bom.quantity_needed as consumed_per_unit,
    'Her uretim icin bu kadar azalmali' as note
FROM raw_materials rm
JOIN production_plan_bom_snapshot bom ON bom.material_id = rm.id AND bom.material_type = 'raw'
WHERE bom.plan_id = (
    SELECT id FROM production_plans 
    WHERE created_at >= NOW() - INTERVAL '10 minutes'
    ORDER BY created_at DESC 
    LIMIT 1
)
ORDER BY rm.code;
```

**Beklenen Sonu√ß:**
- Stoklar BOM snapshot'a g√∂re azaldƒ±
- quantity deƒüi≈üti

**Sorun ya≈üarsanƒ±z:** "Adƒ±m 12'de problem" + stok deƒüerleri

---

### ADIM 13: Kritik Stok Bildirimi Testi (SQL) - MIGRATION KANITI!

**Ne Yapƒ±lacak:** Bir hammaddeyi kritik seviyeye d√º≈ü√ºr ve bildirim kontrol√º

**SQL:**
```sql
-- 1. Hammaddeyi kritik seviyeye d√º≈ü√ºr
UPDATE raw_materials
SET quantity = critical_level - 10
WHERE code = 'HM-BOYA-001'
RETURNING code, quantity, critical_level;

-- 2. 2 saniye bekle
SELECT pg_sleep(2);

-- 3. Bildirim olu≈ütu mu ve target_roles dolu mu kontrol et
SELECT 
    type,
    title,
    message,
    target_roles,  -- ‚Üê BU DOLU OLMALI!
    severity,
    is_read,
    CASE 
        WHEN target_roles IS NOT NULL AND 'planlama' = ANY(target_roles)
        THEN '‚úÖ MIGRATION BASARILI - target_roles rol bazli!'
        ELSE '‚ùå HATA - target_roles bos!'
    END as test_result,
    created_at
FROM notifications
WHERE type = 'critical_stock'
  AND created_at >= NOW() - INTERVAL '1 minute'
ORDER BY created_at DESC
LIMIT 3;
```

**Beklenen Sonu√ß:**
```
type: critical_stock
target_roles: ["planlama","yonetici"]  ‚Üê DOLU!
test_result: "MIGRATION BASARILI - target_roles rol bazli!"
```

**Sorun ya≈üarsanƒ±z:** "Adƒ±m 13'te problem" + SQL sonucu

---

### ADIM 14: Birden Fazla Barkod Okutma (UI/SQL)

**Ne Yapƒ±lacak:** 2-3 kez daha barkod okut, her seferinde kontrol et

**SQL (Her okutmadan sonra √ßalƒ±≈ütƒ±r):**
```sql
-- Yeni production log ekle
INSERT INTO production_logs (plan_id, operator_id, barcode_scanned, quantity_produced)
SELECT pp.id, pp.assigned_operator_id, fp.barcode, 1
FROM production_plans pp
JOIN finished_products fp ON pp.product_id = fp.id
WHERE pp.created_at >= NOW() - INTERVAL '10 minutes'
  AND pp.status = 'devam_ediyor'
ORDER BY pp.created_at DESC
LIMIT 1
RETURNING id, barcode_scanned;

-- Production plan g√ºncellendi mi?
SELECT 
    planned_quantity,
    produced_quantity,
    ROUND((produced_quantity / planned_quantity) * 100, 2) as completion_percentage
FROM production_plans
WHERE created_at >= NOW() - INTERVAL '10 minutes'
ORDER BY created_at DESC
LIMIT 1;
```

**Beklenen Sonu√ß:**
- produced_quantity arttƒ±
- completion_percentage g√ºncellendi

**Sorun ya≈üarsanƒ±z:** "Adƒ±m 14'te problem"

---

### ADIM 15: Final Validation (SQL) - MIGRATION KANITI!

**Ne Yapƒ±lacak:** T√ºm migration √∂zelliklerini kontrol et

**SQL:**
```sql
-- FINAL TEST: Tum migration ozellikleri
SELECT 
    'TEST RAPORU' as section,
    '' as data;

-- 1. Kac production log eklendi?
SELECT 
    '1. Production Logs:' as test,
    COUNT(*) as log_count,
    'En az 1 olmali' as expected
FROM production_logs
WHERE timestamp >= NOW() - INTERVAL '10 minutes';

-- 2. Kac stock movement olu≈ütu?
SELECT 
    '2. Stock Movements:' as test,
    COUNT(*) as movement_count,
    COUNT(production_log_id) as with_log_id,
    CASE 
        WHEN COUNT(*) = COUNT(production_log_id)
        THEN 'MIGRATION BASARILI - Hepsi production_log_id ile!'
        ELSE 'SORUN - Bazi kayitlarda production_log_id yok'
    END as test_result
FROM stock_movements
WHERE created_at >= NOW() - INTERVAL '10 minutes';

-- 3. target_roles bildirimi var mƒ±?
SELECT 
    '3. Critical Notifications:' as test,
    COUNT(*) as notification_count,
    COUNT(target_roles) as with_roles,
    CASE 
        WHEN COUNT(target_roles) > 0
        THEN 'MIGRATION BASARILI - Rol bazli bildirim!'
        ELSE 'SORUN - target_roles bos'
    END as test_result
FROM notifications
WHERE type = 'critical_stock'
  AND created_at >= NOW() - INTERVAL '10 minutes';

-- 4. Production plan produced_quantity g√ºncellenmi≈ü mi?
SELECT 
    '4. Production Progress:' as test,
    planned_quantity,
    produced_quantity,
    CASE 
        WHEN produced_quantity > 0
        THEN 'BASARILI - Trigger update_stock_on_production calisti!'
        ELSE 'SORUN - produced_quantity guncellenme'
    END as test_result
FROM production_plans
WHERE created_at >= NOW() - INTERVAL '10 minutes'
ORDER BY created_at DESC
LIMIT 1;
```

**Beklenen Sonu√ß:**
```
1. Production Logs: 3+
2. Stock Movements: 6-9 kayƒ±t, HEPSI production_log_id ile
3. Critical Notifications: 1+, target_roles dolu
4. Production Progress: produced_quantity > 0
```

**Sorun ya≈üarsanƒ±z:** "Adƒ±m 15'te problem" + hangi test ba≈üarƒ±sƒ±z

---

## üìä TEST BA≈ûARI KRƒ∞TERLERƒ∞

Migration **BA≈ûARILI** sayƒ±lƒ±r eƒüer:

- [x] ADIM 4: BOM snapshot olu≈ütu
- [x] ADIM 10: production_log_id DOLU (en kritik!)
- [x] ADIM 13: target_roles DOLU (en kritik!)
- [x] ADIM 15: T√ºm testler ge√ßti

---

## üéØ BA≈ûLAYALIM!

**ADIM 0'dan ba≈ülayƒ±n** ve her adƒ±mda sonucu bildirin.

Sorun ya≈üarsanƒ±z: **"Adƒ±m X'te problem"** yazƒ±n ve detaylarƒ± payla≈üƒ±n.

---

**Hazƒ±rsƒ±nƒ±z! ADIM 0'dan ba≈ülayƒ±n!** üöÄ

