---
alwaysApply: true
---

# ğŸš€ Thunder ERP - CanlÄ± Ortam GeliÅŸtirme KurallarÄ±

**âš ï¸ KRÄ°TÄ°K UYARI: Bu proje artÄ±k CANLI ORTAMDA Ã§alÄ±ÅŸÄ±yor!**

## ğŸ—ï¸ PROJE YAPISI

### Teknoloji Stack
- **Framework:** Next.js 15.5.4 (App Router)
- **Database:** Supabase PostgreSQL (MCP entegrasyonu aktif)
- **AI:** OpenAI GPT-4 (Multi-Agent Architecture)
- **Deployment:** PM2 (ecosystem.config.js)
- **State:** Zustand stores
- **UI:** Shadcn/ui + Tailwind CSS v4

### Ana ModÃ¼ller
- **Ãœretim YÃ¶netimi** (`/uretim/*`) - SipariÅŸ, planlama, operatÃ¶r atama
- **Stok YÃ¶netimi** (`/stok/*`) - Hammadde, yarÄ± mamul, nihai Ã¼rÃ¼n
- **Depo YÃ¶netimi** (`/depo-zone-yonetimi`) - Zone bazlÄ± stok takibi
- **AI Dashboard** (`/ai-*`) - Agent performans, maliyetler, konuÅŸmalar, onaylar
- **Operator Dashboard** (`/operator-dashboard`) - Barkod okuma, Ã¼retim kaydÄ±
- **Bildirimler & Ä°ÅŸlem GeÃ§miÅŸi** - Audit logging ve notifications

## ğŸ›¡ï¸ TEMEL GÃœVENLÄ°K KURALLARI

### 1. **VERÄ° KORUMA** ğŸ”’
```bash
âŒ ASLA YAPMA:
- CanlÄ± veriyi silme
- Mevcut tablolarÄ± DROP etme
- Kritik verileri gÃ¼ncelleme
- Bulk DELETE iÅŸlemleri
- Production_logs, stock_movements, audit_logs tablolarÄ±ndan silme

âœ… GÃœVENLÄ° YAKLAÅIM:
- Soft delete kullan
- Backup al (Supabase Dashboard veya MCP)
- Test ortamÄ±nda dene
- Rollback planÄ± hazÄ±rla
- Migration'larÄ± MCP ile uygula
```

### 2. **DATABASE DEÄÄ°ÅÄ°KLÄ°KLERÄ°** ğŸ—„ï¸
```sql
âŒ TEHLÄ°KELÄ°:
DROP TABLE users;
ALTER TABLE orders DROP COLUMN customer_id;
DELETE FROM stock_movements;
DELETE FROM production_logs;
DELETE FROM audit_logs;

âœ… GÃœVENLÄ°:
-- Migration ile yeni kolon ekle (Supabase MCP kullan)
ALTER TABLE orders ADD COLUMN new_field VARCHAR(255) DEFAULT '';
-- Soft delete
UPDATE orders SET is_deleted = true WHERE id = ?;
-- Backup ile gÃ¼ncelleme
UPDATE stock_movements SET status = 'archived' WHERE created_at < ?;
-- Production trigger'larÄ± gÃ¼ncelle (UUID casting kontrolÃ¼)
```

**Ã–NEMLÄ°:** Database deÄŸiÅŸikliklerini **Supabase MCP** ile yap:
```typescript
// âœ… DOÄRU: Migration MCP ile uygula
mcp_supabase_apply_migration({ name: 'migration_name', query: 'SQL...' })

// âŒ YANLIÅ: Direkt SQL execute etme (veri kaybÄ± riski)
```

### 3. **PRODUCTION TRIGGER'LARI** âš™ï¸
```sql
-- Production log insert edildiÄŸinde Ã§alÄ±ÅŸan trigger'lar:
-- 1. update_stock_on_production() - Nihai Ã¼rÃ¼n stokunu artÄ±rÄ±r
-- 2. consume_materials_on_production() - BOM'dan malzeme tÃ¼ketir

-- Ã–NEMLÄ°: format() iÃ§inde UUID casting ZORUNLU
-- âœ… DOÄRU:
v_error_context := format('plan_id=%s', NEW.plan_id::TEXT);
-- âŒ YANLIÅ:
v_error_context := format('plan_id=%s', NEW.plan_id); -- "operator does not exist" hatasÄ±!
```

### 4. **API DEÄÄ°ÅÄ°KLÄ°KLERÄ°** ğŸ”Œ
```typescript
âŒ BREAKING CHANGES:
// Mevcut endpoint'i deÄŸiÅŸtirme
GET /api/orders â†’ POST /api/orders

âœ… BACKWARD COMPATIBILITY:
// Yeni versiyon ekle
GET /api/v2/orders
// Mevcut endpoint'i koru
GET /api/orders (deprecated)
```

### 5. **AI AGENT SÄ°STEMÄ°** ğŸ¤–
```typescript
// âœ… DOÄRU: Agent'lar production log validation iÃ§in kullanÄ±lÄ±r
// Agent validation baÅŸarÄ±sÄ±z olsa bile operatÃ¶r Ã¼retimi devam eder (graceful degradation)

// âŒ YANLIÅ: Agent hatasÄ± production'Ä± durdurur
if (!agentResult.success) throw new Error('Agent validation failed');

// âœ… DOÄRU: Warning ver ama devam et
if (agentResult.finalDecision === 'rejected') {
  logger.warn('AI Agent reddetti ama iÅŸleme devam ediliyor');
  // Production log oluÅŸturulmaya devam eder
}
```

**AI Agent Ã–zellikleri:**
- **6 Agent:** Planning, Warehouse, Production, Purchase, Manager, Developer
- **Zero Error Protocol:** 4 katmanlÄ± doÄŸrulama (Self, Cross-Agent, Consensus, Database)
- **Human Approvals:** Kritik kararlar iÃ§in onay sistemi (`human_approvals` tablosu)
- **Cost Tracking:** `agent_costs` tablosunda token ve maliyet takibi
- **Conversation Logs:** `agent_logs` tablosunda tÃ¼m konuÅŸmalar

**Environment Variables:**
```bash
# .env.local (sunucuda)
OPENAI_API_KEY=sk-proj-...          # AI Ã¶zellikleri iÃ§in ZORUNLU
AGENT_ENABLED=true                  # AI Agent'larÄ± aktif et
AGENT_LOGGING_ENABLED=true          # AI log'larÄ± database'e kaydet
```

## ğŸ“Š CANLI VERÄ° KORUMA LÄ°STESÄ°

### **Kritik Tablolar** âš ï¸
```sql
-- ASLA SÄ°LME/GÃœNCELLEME YAPMA (Migration gerektirir):
users                    -- KullanÄ±cÄ± hesaplarÄ±
customers               -- MÃ¼ÅŸteri verileri
orders                  -- SipariÅŸ geÃ§miÅŸi
order_items             -- SipariÅŸ kalemleri
production_plans        -- Ãœretim planlarÄ±
production_logs         -- Ãœretim kayÄ±tlarÄ± (operator kayÄ±tlarÄ±)
raw_materials           -- Hammadde stoklarÄ±
semi_finished_products  -- YarÄ± mamul stoklarÄ±
finished_products       -- Nihai Ã¼rÃ¼n stoklarÄ±
stock_movements         -- Stok hareketleri (audit iÃ§in kritik!)
audit_logs              -- Audit kayÄ±tlarÄ±
material_reservations   -- Malzeme rezervasyonlarÄ±
warehouse_zones         -- Depo zone'larÄ±
zone_inventories        -- Zone stoklarÄ±
zone_transfers          -- Zone transferleri
agent_logs              -- AI Agent konuÅŸma loglarÄ±
agent_costs             -- AI maliyet takibi
human_approvals         -- AI onay kayÄ±tlarÄ±
notifications           -- Bildirimler
```

### **GÃ¼venli Ä°ÅŸlemler** âœ…
```sql
-- Bu iÅŸlemler gÃ¼venli:
INSERT INTO new_table...           -- Yeni kayÄ±t ekleme
UPDATE status = 'active'           -- Status gÃ¼ncelleme
UPDATE quantity = 0                -- Stok sÄ±fÄ±rlama (tek seferlik)
SELECT ...                         -- Veri okuma
CREATE INDEX ...                   -- Index ekleme
CREATE OR REPLACE FUNCTION ...     -- Fonksiyon gÃ¼ncelleme
```

### **Stok YÃ¶netimi KurallarÄ±**
```sql
-- âœ… Stok sÄ±fÄ±rlama (1 defalÄ±k iÅŸlem):
UPDATE finished_products SET quantity = 0 WHERE quantity > 0;

-- âœ… Rezervasyon sistemi:
-- material_reservations tablosu production_plans ile otomatik oluÅŸur
-- Production log insert edildiÄŸinde otomatik consumed_quantity gÃ¼ncellenir
-- Plan iptal edildiÄŸinde rezervasyonlar otomatik serbest bÄ±rakÄ±lÄ±r

-- âŒ Manuel rezervasyon silme:
DELETE FROM material_reservations; -- TRÄ°GGER'LAR BOZULUR!
```

## ğŸ¤– AI AGENT KURALLARI

### Agent KullanÄ±mÄ±
- **Production Log Validation:** Operator Ã¼retim kayÄ±tlarÄ±nÄ± doÄŸrular
- **Order Approval:** SipariÅŸ onaylarÄ±nda konsensÃ¼s oluÅŸturur
- **Developer Reports:** Sistem analizi ve iyileÅŸtirme Ã¶nerileri

### Graceful Degradation
```typescript
// âœ… Agent hatasÄ± olsa bile sistem Ã§alÄ±ÅŸmaya devam etmeli
if (process.env.AGENT_ENABLED !== 'true') {
  // Agent devre dÄ±ÅŸÄ±ysa normal akÄ±ÅŸa devam et
  return await createProductionLog(...);
}

try {
  const agentResult = await orchestrator.startConversation(...);
  // Agent sonucu logla ama production'Ä± durdurma
} catch (error) {
  logger.warn('AI Agent hatasÄ±, manuel kayÄ±t devam ediyor');
  // Hata olsa bile production log oluÅŸtur
}
```

### Agent Logging
- **Memory Logging:** HÄ±zlÄ± eriÅŸim iÃ§in in-memory
- **Database Logging:** `agent_logs` tablosuna kaydedilir (AGENT_LOGGING_ENABLED)
- **Cost Tracking:** Her API Ã§aÄŸrÄ±sÄ± `agent_costs` tablosuna kaydedilir

### Human Approvals
- Kritik AI kararlarÄ± `human_approvals` tablosuna kaydedilir
- YÃ¶netici/Planlama rolleri onaylayabilir/reddedebilir
- Expiry date kontrolÃ¼ yapÄ±lÄ±r (24 saat)

## ğŸ” CODE REVIEW CHECKLIST

### **Her PR'da Kontrol Et** âœ…
- [ ] **Breaking Change:** Mevcut API'ler bozuldu mu?
- [ ] **Data Safety:** CanlÄ± veri etkileniyor mu?
- [ ] **Error Handling:** Hata durumlarÄ± handle ediliyor mu?
- [ ] **Logging:** Ã–nemli iÅŸlemler loglanÄ±yor mu? (logger.ts kullan)
- [ ] **Performance:** Query'ler optimize mi?
- [ ] **Security:** SQL injection korumasÄ± var mÄ±?
- [ ] **AI Agent:** Agent hatasÄ± graceful degradation ile handle ediliyor mu?
- [ ] **Trigger Safety:** UUID casting format() iÃ§inde doÄŸru mu?
- [ ] **Rollback:** Geri alma planÄ± hazÄ±r mÄ±?
- [ ] **Testing:** Test coverage yeterli mi?

### **Red Flags** ğŸš©
```typescript
// Bu pattern'larÄ± ASLA kullanma:
DELETE FROM users;                    // Bulk delete
DROP TABLE orders;                   // Table drop
ALTER TABLE DROP COLUMN;             // Column drop
UPDATE * SET field = value;          // Bulk update
eval(userInput);                     // Code injection
format('id=%s', uuid)                // UUID casting eksik (trigger'larda)
await supabase.raw()                 // KullanÄ±lmÄ±yor artÄ±k, execute_sql kullan
```

## ğŸš¨ ACÄ°L DURUM PROSEDÃœRÃœ

### **Sistem Ã‡Ã¶ktÃ¼ÄŸÃ¼nde** ğŸ’¥
```bash
# 1. HÄ±zlÄ± rollback
git revert <commit-hash>

# 2. PM2 restart (sunucuda)
pm2 restart thunder-erp

# 3. Database restore (Supabase Dashboard veya MCP)
# Supabase Dashboard > Database > Backups

# 4. Monitor et
pm2 logs thunder-erp --lines 100

# 5. Migration rollback (gerekirse)
# Supabase Dashboard > Database > Migrations
```

### **Production Log HatasÄ±**
```bash
# "operator does not exist: text = uuid" hatasÄ±:
# 1. Trigger fonksiyonlarÄ±nÄ± kontrol et
# 2. format() iÃ§inde ::TEXT casting var mÄ±?
# 3. Migration uygula (MCP ile)
mcp_supabase_apply_migration({ name: 'fix_operator_type_cast', query: '...' })
```

### **AI Agent Loop HatasÄ±**
```bash
# Conversation loop olduÄŸunda:
# 1. API endpoint ile durdur
POST /api/ai/conversations/[id]/stop

# 2. Database'de manuel olarak tamamlandÄ± iÅŸaretle
UPDATE agent_logs SET action = 'conversation_failed' 
WHERE conversation_id = '...' AND action = 'in_progress';
```

## âš¡ HIZLI REFERANS

### **GÃ¼venli Komutlar** âœ…
```bash
# Sunucuda deployment
cd /var/www/thunder-erp
git pull origin main
npm install
npm run build
pm2 restart thunder-erp

# Migration uygulama (Supabase MCP)
mcp_supabase_apply_migration({ name: 'migration_name', query: 'SQL...' })

# Stok sÄ±fÄ±rlama (1 defalÄ±k)
UPDATE finished_products SET quantity = 0 WHERE quantity > 0;

# Log kontrolÃ¼
pm2 logs thunder-erp --lines 50
```

### **Tehlikeli Komutlar** âŒ
```bash
# ASLA Ã‡ALIÅTIRMA:
DROP DATABASE thunder_erp;
rm -rf /var/www/thunder-erp;
killall node;
DELETE FROM production_logs;
DELETE FROM stock_movements;
DELETE FROM audit_logs;
```

## ğŸ“¦ DEPLOYMENT KURALLARI

### **PM2 Configuration**
- **Config File:** `ecosystem.config.js`
- **Deployment Path:** `/var/www/thunder-erp`
- **Logs:** `~/.pm2/logs/thunder-erp-*.log`
- **Restart:** `pm2 restart thunder-erp`

### **Environment Variables (Sunucuda)**
```bash
# /var/www/thunder-erp/.env.local
NEXT_PUBLIC_SUPABASE_URL=...
NEXT_PUBLIC_SUPABASE_ANON_KEY=...
SUPABASE_SERVICE_ROLE_KEY=...
JWT_SECRET=...
NODE_ENV=production
OPENAI_API_KEY=sk-proj-...          # AI iÃ§in ZORUNLU
AGENT_ENABLED=true                  # AI Agent'larÄ± aktif et
```

### **Git Workflow**
```bash
# âœ… DOÄRU: Feature branch'ten main'e merge
git checkout -b feature/new-feature
git commit -m "feat: yeni Ã¶zellik"
git push origin feature/new-feature
# PR oluÅŸtur ve merge et

# âŒ YANLIÅ: Direkt main'e commit
git checkout main
git commit -m "fix: hotfix"  # âŒ Production'Ä± bozabilir!
```

## ğŸ—„ï¸ SUPABASE MCP KULLANIMI

### **Migration Uygulama**
```typescript
// âœ… DOÄRU: MCP ile migration
await mcp_supabase_apply_migration({
  name: 'fix_operator_type_cast',
  query: `CREATE OR REPLACE FUNCTION ...`
});

// âœ… DOÄRU: SQL execute (read-only veya gÃ¼venli iÅŸlemler)
await mcp_supabase_execute_sql({
  query: 'SELECT * FROM production_plans LIMIT 10'
});
```

### **MCP Tool'larÄ±**
- `mcp_supabase_apply_migration` - Migration uygula (DDL)
- `mcp_supabase_execute_sql` - SQL Ã§alÄ±ÅŸtÄ±r (SELECT, gÃ¼venli UPDATE)
- `mcp_supabase_list_tables` - TablolarÄ± listele
- `mcp_supabase_get_logs` - Log'larÄ± getir
- `mcp_supabase_get_advisors` - GÃ¼venlik/performans Ã¶nerileri

## ğŸ¯ HEDEF
**SÄ±fÄ±r downtime, sÄ±fÄ±r veri kaybÄ±, maksimum gÃ¼venlik, AI destekli karar verme!**

---

## ğŸ“ NOTLAR

### **Son YapÄ±lan DeÄŸiÅŸiklikler**
- âœ… Production trigger'larÄ± UUID casting ile gÃ¼ncellendi
- âœ… AI Agent sistemi production-ready
- âœ… Human approval sistemi entegre edildi
- âœ… Agent cost tracking aktif
- âœ… Operator dashboard production log validation ile entegre
- âœ… Material reservation sistemi otomatik Ã§alÄ±ÅŸÄ±yor
- âœ… Warehouse zone management aktif

### **Bilinmesi Gerekenler**
- Production log insert edildiÄŸinde **otomatik** trigger'lar Ã§alÄ±ÅŸÄ±r:
  1. `update_stock_on_production()` - Nihai Ã¼rÃ¼n stoku artar
  2. `consume_materials_on_production()` - BOM malzemeleri tÃ¼ketilir
  3. `material_reservations` otomatik gÃ¼ncellenir
  4. `stock_movements` kayÄ±tlarÄ± oluÅŸur
- AI Agent validation baÅŸarÄ±sÄ±z olsa bile production log oluÅŸturulur (operatÃ¶r Ã¼retimi)
- Operator dashboard'da barkod okuma ile Ã¼retim kaydÄ± yapÄ±lÄ±r
- Stok hareketleri **asla silinmemeli** (audit iÃ§in kritik)

---

**ğŸ“… Son GÃ¼ncelleme:** 2025-01-27  
**ğŸ”„ Versiyon:** 2.0.0 Production Ready (AI Agent Enabled)  
**ğŸ—„ï¸ Database:** Supabase PostgreSQL (MCP Integrated)  
**ğŸš€ Deployment:** PM2 (ecosystem.config.js)  
**ğŸ¤– AI:** Multi-Agent Architecture (6 Agents, Zero Error Protocol)
